const datasetDropdown=document.querySelector("#dataset-attr-select"),xAttrDropdown=document.querySelector("#x-attr-select"),yAttrDropdown=document.querySelector("#y-attr-select"),colorDropdown=document.querySelector("#color-attr-select"),boxplotDropdown=document.querySelector("#boxplot-attr-select"),submitBtn=document.querySelector("#update-plot");let data=null,selectedData=null;const scatterPlotSvg=d3.select("#scatterPlot"),boxPlotSvg=d3.select("#boxPlot"),margin={top:10,right:30,bottom:50,left:60},width=+scatterPlotSvg.style("width").replace("px",""),height=+scatterPlotSvg.style("height").replace("px",""),innerWidth=width-margin.left-margin.right,innerHeight=height-margin.top-margin.bottom;let gScatterPlot=scatterPlotSvg.append("g").attr("transform",`translate(${margin.left},${margin.top})`),gBoxPlotSvg=boxPlotSvg.append("g").attr("transform",`translate(${margin.left},${margin.top})`);const color=d3.scaleOrdinal(d3.schemeSet2),xScaleScatterPlot=d3.scaleLinear().domain([0,0]).range([0,innerWidth]),yScaleScatterPlot=d3.scaleLinear().domain([0,0]).range([innerHeight,0]),yAxisScatterPlot=gScatterPlot.append("g").call(d3.axisLeft(yScaleScatterPlot)).style("opacity",0),xAxisScatterPlot=gScatterPlot.append("g").attr("transform",`translate(0,${innerHeight})`).call(d3.axisBottom(xScaleScatterPlot)).style("opacity",0),xScaleBoxPlot=d3.scaleBand().range([0,innerWidth]).padding(.5),yScaleBoxPlot=d3.scaleLinear().range([innerHeight,0]),xAxisBoxPlot=gBoxPlotSvg.append("g").attr("transform",`translate(0,${innerHeight})`),yAxisBoxPlot=gBoxPlotSvg.append("g");datasetDropdown.addEventListener("change",()=>{function a(a){const b=[xAttrDropdown,yAttrDropdown,colorDropdown,boxplotDropdown];for(let e of b)e.disabled=a}function b(a){const b={},e=a.slice(0,10);return a.columns.forEach(a=>{const f=e.every(b=>!isNaN(+b[a]));b[a]=f?"quantitative":"categorical"}),b}function e(a){const e=b(a),g=a.columns.filter(a=>"quantitative"===e[a]),h=a.columns.filter(a=>"categorical"===e[a]);f(xAttrDropdown,g),f(yAttrDropdown,g),f(colorDropdown,h),f(boxplotDropdown,g)}function f(a,b){a.innerHTML="";const e=document.createElement("option");e.value="",e.selected=!0,a.appendChild(e),b.forEach(b=>{const e=document.createElement("option");e.value=b,e.textContent=b,a.appendChild(e)})}function g(a){const e=b(a);a.forEach(a=>{Object.entries(a).forEach(b=>{const[f,g]=b;"quantitative"===e[f]&&(a[f]=parseFloat(g))})})}if(console.log(`Dataset ${datasetDropdown.value} Selected`),selectedValue=datasetDropdown.value,""==selectedValue)data=null,a(!0),setSubmitBtnStatus(!0);else{const b=`./data/${selectedValue}.csv`;d3.csv(b).then(b=>{a(!1),e(b),g(b),data=b}).catch(b=>{console.log("Error loading the dataset:",b),data=null,a(!0),setSubmitBtnStatus(!0),Swal.fire({icon:"error",title:`Fail to Load Dataset ${selectedValue}`,text:b})})}}),submitBtn.addEventListener("click",()=>{function a(a,b,f){function g(){let a=scatterPlotSvg.select(".colorkey");a.empty()||a.remove();const b=Array.from(new Set(data.map(a=>a[f])));a=scatterPlotSvg.append("g").attr("class","colorkey").attr("transform",`translate(${innerWidth-20}, 10)`);let e=10,g=0;b.forEach(b=>{let f=a.append("rect").attr("width",10).attr("height",10).attr("x",0).attr("y",e).style("fill",color(b)),h=a.append("text").attr("x",15).attr("y",e+5).attr("dy","0.35em").style("font-size","12px").text(b).style("visibility","hidden"),i=h.node().getBBox().width;i>g&&(g=i),e+=20}),a.attr("transform",`translate(${innerWidth-g}, 10)`),a.selectAll("text").style("visibility","visible")}const h=d3.max(data,b=>b[a]),i=d3.min(data,b=>b[a]),j=d3.max(data,a=>a[b]),k=d3.min(data,a=>a[b]);xScaleScatterPlot.domain([i-.03*(h-i),h+.03*(h-i)]).nice(),yScaleScatterPlot.domain([k-.03*(j-k),j+.03*(j-k)]).nice(),xAxisScatterPlot.transition().duration(e).call(d3.axisBottom(xScaleScatterPlot)).style("opacity",1),yAxisScatterPlot.transition().duration(e).call(d3.axisLeft(yScaleScatterPlot)).style("opacity",1),scatterPlotSvg.selectAll(".scatterplot-label").transition().duration(300).style("opacity",0).remove(),scatterPlotSvg.append("text").attr("class","scatterplot-label").attr("transform",`translate(${innerWidth/2+margin.left}, ${height-15})`).style("text-anchor","middle").style("opacity",0).text(a).transition().duration(e).style("opacity",1),scatterPlotSvg.append("text").attr("class","scatterplot-label").attr("transform","rotate(-90)").attr("y",5).attr("x",0-(innerHeight/2+margin.top)).attr("dy","1em").style("text-anchor","middle").style("opacity",0).text(b).transition().duration(e).style("opacity",1),console.log(data),g();let l=gScatterPlot.select(".dots-group");l.empty()&&(l=gScatterPlot.append("g").attr("class","dots-group"));const m=l.selectAll("circle").data(data,(a,b)=>b);m.join(e=>e.append("circle").attr("cx",b=>xScaleScatterPlot(b[a])).attr("cy",a=>yScaleScatterPlot(a[b])).attr("r",0).style("fill",a=>color(a[f])).transition().duration(1e3).attr("r",3).attr("id",(a,b)=>`scatter-plot-dot-${b}`),e=>e.transition().duration(1e3).attr("cx",b=>xScaleScatterPlot(b[a])).attr("cy",a=>yScaleScatterPlot(a[b])).style("fill",a=>color(a[f])),a=>a.transition().duration(1e3).attr("r",0).remove())}function b(a,b){function f(){const e=Array.from(new Set(selectedData.map(b=>b[a])));let f={};for(c of e)f[c]=[];for(d of selectedData){const e=d[a];f[e].push(d[b])}let g=Object.keys(f).map(a=>({name:a,values:f[a]}));return g}if(""===a)return;(null===selectedData||0===selectedData.length)&&(selectedData=[]);const h=f();console.log(h),h.forEach(a=>{a.values.sort(d3.ascending);const b=d3.quantile(a.values,.25),e=d3.quantile(a.values,.5),f=d3.quantile(a.values,.75),g=f-b,h=a.values[0],i=a.values[a.values.length-1],j=Math.max(h,b-1.5*g),k=Math.min(i,f+1.5*g);a.quartiles=[b,e,f],a.range=[j,k],a.outliers=a.values.filter(a=>a<j||a>k)}),console.log(h);const i=d3.max(h,a=>a.range[1]),j=d3.min(h,a=>a.range[0]);xScaleBoxPlot.domain(h.map(a=>a.name)),yScaleBoxPlot.domain([j-.03*(i-j),i+.03*(i-j)]).nice(),xAxisBoxPlot.transition().duration(e).call(d3.axisBottom(xScaleBoxPlot)),yAxisBoxPlot.transition().duration(e).call(d3.axisLeft(yScaleBoxPlot)),boxPlotSvg.selectAll(".scatterplot-label").transition().duration(300).style("opacity",0).remove(),boxPlotSvg.append("text").attr("class","scatterplot-label").attr("transform",`translate(${innerWidth/2+margin.left}, ${height-15})`).style("text-anchor","middle").style("opacity",0).text(a).transition().duration(e).style("opacity",1),boxPlotSvg.append("text").attr("class","scatterplot-label").attr("transform","rotate(-90)").attr("y",5).attr("x",0-(innerHeight/2+margin.top)).attr("dy","1em").style("text-anchor","middle").style("opacity",0).text(b).transition().duration(e).style("opacity",1);const k=.2*xScaleBoxPlot.bandwidth(),l=gBoxPlotSvg.selectAll(".box-group").data(h,a=>a.name).join(a=>{const b=a.append("g").attr("class","box-group").attr("transform",a=>`translate(${xScaleBoxPlot(a.name)},0)`).style("opacity",0);b.transition().duration(500).style("opacity",1),b.append("line").attr("class","range-line").attr("stroke","currentColor").attr("x1",xScaleBoxPlot.bandwidth()/2).attr("x2",xScaleBoxPlot.bandwidth()/2).attr("y1",a=>yScaleBoxPlot(a.range[0])).attr("y2",a=>yScaleBoxPlot(a.range[1])),b.append("rect").attr("class","quartile-rect").style("fill",a=>color(a.name)).attr("x",0).attr("width",xScaleBoxPlot.bandwidth()).attr("y",a=>yScaleBoxPlot(a.quartiles[2])).attr("height",a=>yScaleBoxPlot(a.quartiles[0])-yScaleBoxPlot(a.quartiles[2])),b.append("line").attr("class","median-line").attr("stroke","currentColor").attr("stroke-width",2).attr("x1",0).attr("x2",xScaleBoxPlot.bandwidth()).attr("y1",a=>yScaleBoxPlot(a.quartiles[1])).attr("y2",a=>yScaleBoxPlot(a.quartiles[1])),b.append("line").attr("class","min-line").attr("stroke","currentColor").attr("stroke-width",1).attr("x1",k).attr("x2",xScaleBoxPlot.bandwidth()-k).attr("y1",a=>yScaleBoxPlot(a.range[0])).attr("y2",a=>yScaleBoxPlot(a.range[0])),b.append("line").attr("class","max-line").attr("stroke","currentColor").attr("stroke-width",1).attr("x1",k).attr("x2",xScaleBoxPlot.bandwidth()-k).attr("y1",a=>yScaleBoxPlot(a.range[1])).attr("y2",a=>yScaleBoxPlot(a.range[1])),b.selectAll(".outlier-circle").data(a=>a.outliers).join(a=>a.append("circle").attr("class","outlier-circle").style("fill",a=>color(a.name)).attr("fill-opacity",.7).attr("r",2).attr("cx",xScaleBoxPlot.bandwidth()/2).attr("cy",a=>yScaleBoxPlot(a)),a=>a.style("fill",a=>color(a.name)).attr("cx",xScaleBoxPlot.bandwidth()/2).attr("cy",a=>yScaleBoxPlot(a)))},a=>{const b=a.transition().duration(750).attr("transform",a=>`translate(${xScaleBoxPlot(a.name)},0)`);b.select(".range-line").attr("x1",xScaleBoxPlot.bandwidth()/2).attr("x2",xScaleBoxPlot.bandwidth()/2).attr("y1",a=>yScaleBoxPlot(a.range[0])).attr("y2",a=>yScaleBoxPlot(a.range[1])),b.select(".quartile-rect").attr("width",xScaleBoxPlot.bandwidth()).attr("y",a=>yScaleBoxPlot(a.quartiles[2])).attr("height",a=>yScaleBoxPlot(a.quartiles[0])-yScaleBoxPlot(a.quartiles[2])).style("fill",a=>color(a.name)),b.select(".median-line").attr("x2",xScaleBoxPlot.bandwidth()).attr("y1",a=>yScaleBoxPlot(a.quartiles[1])).attr("y2",a=>yScaleBoxPlot(a.quartiles[1])),b.select(".min-line").attr("x1",k).attr("x2",xScaleBoxPlot.bandwidth()-k).attr("y1",a=>yScaleBoxPlot(a.range[0])).attr("y2",a=>yScaleBoxPlot(a.range[0])),b.select(".max-line").attr("x1",k).attr("x2",xScaleBoxPlot.bandwidth()-k).attr("y1",a=>yScaleBoxPlot(a.range[1])).attr("y2",a=>yScaleBoxPlot(a.range[1])),a.selectAll(".outlier-circle").data(a=>a.outliers).join(a=>a.append("circle").attr("class","outlier-circle").style("fill",a=>color(a.name)).attr("fill-opacity",.7).attr("r",2).attr("cx",xScaleBoxPlot.bandwidth()/2).attr("cy",a=>yScaleBoxPlot(a)),a=>a.style("fill",a=>color(a.name)).attr("cx",xScaleBoxPlot.bandwidth()/2).attr("cy",a=>yScaleBoxPlot(a)))},a=>a.transition().duration(375).style("opacity",0).select(".quartile-rect").attr("height",0).end().then(()=>a.remove()))}const e=1e3,[f,g,h,i]=function(){const a=xAttrDropdown.value,b=yAttrDropdown.value,e=colorDropdown.value,f=boxplotDropdown.value;return[a,b,e,f]}();a(f,g,h),d3.select("#scatterPlot").call(function(a,e,f,g){function h(){d3.select("#lasso").style("stroke","black").style("stroke-width",2).style("fill","#00000030").attr("d",m(l))}function i(){l=[],selectedData=null,d3.selectAll("#scatterPlot .dots-group circle").attr("stroke",null),d3.select("#lasso").remove(),d3.select("#scatterPlot").append("path").attr("id","lasso")}function j(a){let b=a.sourceEvent.offsetX,e=a.sourceEvent.offsetY;l.push([b,e]),h()}function k(){if(0===l.length)return selectedData=null,void b(f,g);let h=[];d3.selectAll("#scatterPlot .dots-group circle").each((b,f)=>{let g=[xScaleScatterPlot(b[a])+margin.left,yScaleScatterPlot(b[e])+margin.top];d3.polygonContains(l,g)&&(d3.select(`#scatter-plot-dot-${f}`).attr("stroke","black"),h.push(b))}),selectedData=h,b(f,g)}let l=[];const m=d3.line();i();const n=d3.drag().on("start",i).on("drag",j).on("end",k);return n}(f,g,h,i))});function setSubmitBtnStatus(a){submitBtn.disabled=""===xAttrDropdown.value||""===yAttrDropdown.value||""==colorDropdown.value||""==boxplotDropdown.value,a&&(submitBtn.disabled=a)}xAttrDropdown.addEventListener("change",()=>{setSubmitBtnStatus()}),yAttrDropdown.addEventListener("change",()=>{setSubmitBtnStatus()}),colorDropdown.addEventListener("change",()=>{setSubmitBtnStatus()}),boxplotDropdown.addEventListener("change",()=>{setSubmitBtnStatus()});